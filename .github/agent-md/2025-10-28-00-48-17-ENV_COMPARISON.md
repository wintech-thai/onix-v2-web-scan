# Environment Variables Comparison - C# vs Next.js

**Date**: 2024-10-18  
**Purpose**: Compare C# and Next.js environment variables to identify missing configuration

---

## Executive Summary

**Status**: ⚠️ **Missing Redis Configuration in Next.js**

### Missing from Next.js `.env`:
1. ✅ **REDIS_HOST** - Commented out (optional for dev, required for production)
2. ✅ **REDIS_PORT** - Commented out (optional for dev, required for production)
3. ⚠️ **LOG_ENDPOINT** - Not present in Next.js (should be NEXT_PUBLIC_LOG_ENDPOINT)
4. ⚠️ **ASPNETCORE_ENVIRONMENT** - Not present (maps to NODE_ENV)

---

## C# Environment Variables

### From `obsoleted/Program.cs` (lines 14-20)

```csharp
//Redis
var redisHost = Environment.GetEnvironmentVariable("REDIS_HOST");
var redisPort = Environment.GetEnvironmentVariable("REDIS_PORT");
var redisHostStr = $"{redisHost}:{redisPort}";

builder.Services.AddSingleton<IConnectionMultiplexer>(
sp => ConnectionMultiplexer.Connect(redisHostStr));
builder.Services.AddScoped<RedisHelper>();
```

**Purpose**: Redis connection for caching encryption keys in production

---

### From `obsoleted/Controllers/VerifyController.cs` (lines 60-65)

```csharp
var e = new EncryptionConfig()
{
    Encryption_Key = Environment.GetEnvironmentVariable("ENCRYPTION_KEY"),
    Encryption_Iv = Environment.GetEnvironmentVariable("ENCRYPTION_IV"),
};
```

**Purpose**: Fallback encryption keys for local development (when Redis not available)

---

### From `obsoleted/Middlewares/AuditLogMiddleware.cs` (line 122)

```csharp
var endPoint = Environment.GetEnvironmentVariable("LOG_ENDPOINT");
if (endPoint == null)
{
    return;
}

try
{
    var content = new StringContent(logJson, Encoding.UTF8, "application/json");
    var response = await _httpClient.PostAsync(endPoint, content);
    // ...
}
```

**Purpose**: External endpoint for sending audit logs

---

### From `obsoleted/Controllers/VerifyController.cs` (line 71)

```csharp
var env = Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT");
var cacheKey = $"CacheLoader:{env}:ScanItemActions:{org}";
```

**Purpose**: Environment name for Redis cache key construction (Development/Production/Staging)

---

## Next.js Environment Variables

### Current `nextjs/.env`

```properties
# Redis Configuration (Production - required when REDIS_HOST is set)
# REDIS_HOST=localhost
# REDIS_PORT=6379

# Encryption Configuration (Required - fallback for local development)
ENCRYPTION_KEY=wCCLYnTAlfFk2ccB
ENCRYPTION_IV=2908yrhozH0ppXmA

# Node Environment
NODE_ENV=development

# Next.js Configuration
PORT=5001
```

---

## Missing Configuration Analysis

### 1. Redis Configuration

**C# Variables**:
```bash
REDIS_HOST=localhost       # Redis server hostname
REDIS_PORT=6379           # Redis server port
```

**Next.js Status**: 
- ✅ Variables defined in `.env` (commented out)
- ⚠️ Not currently used in Next.js code
- ✅ Optional for development (uses env var fallback)
- ⚠️ Required for production (to fetch encryption keys)

**Impact**:
- **Development**: ✅ No impact (uses ENCRYPTION_KEY/ENCRYPTION_IV directly)
- **Production**: ⚠️ Cannot fetch organization-specific encryption keys from Redis

**Usage in C#**:
```csharp
// VerifyController.cs (lines 60-82)
if (_redis == null)
{
    // Local development - use env vars
    return new EncryptionConfig()
    {
        Encryption_Key = Environment.GetEnvironmentVariable("ENCRYPTION_KEY"),
        Encryption_Iv = Environment.GetEnvironmentVariable("ENCRYPTION_IV"),
    };
}

// Production - fetch from Redis
var env = Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT");
var cacheKey = $"CacheLoader:{env}:ScanItemActions:{org}";
var t = _redis.GetObjectAsync<EncryptionConfig>(cacheKey).Result;
```

**Next.js Implementation**:
```typescript
// app/verify/page.tsx (lines 360-361)
// Currently only uses direct env vars (development approach)
const key = process.env.ENCRYPTION_KEY;
const iv = process.env.ENCRYPTION_IV;

// TODO: Add Redis support for production
// if (process.env.REDIS_HOST) {
//   const redis = createClient({ url: `redis://${process.env.REDIS_HOST}:${process.env.REDIS_PORT}` });
//   const cacheKey = `CacheLoader:${process.env.NODE_ENV}:ScanItemActions:${org}`;
//   const config = await redis.get(cacheKey);
// }
```

---

### 2. Log Endpoint Configuration

**C# Variable**:
```bash
LOG_ENDPOINT=https://your-logging-service.com/api/logs
```

**Next.js Status**: 
- ❌ Not defined in `.env`
- ⚠️ Code references `NEXT_PUBLIC_LOG_ENDPOINT` (middleware.ts line 117)
- ⚠️ Optional (logging to console works without it)

**Impact**:
- **Current**: Logs only to console
- **Production**: Cannot send logs to external logging service

**Usage in C#**:
```csharp
// AuditLogMiddleware.cs (line 122)
var endPoint = Environment.GetEnvironmentVariable("LOG_ENDPOINT");
if (endPoint == null)
{
    return; // Skip external logging
}

try
{
    var content = new StringContent(logJson, Encoding.UTF8, "application/json");
    var response = await _httpClient.PostAsync(endPoint, content);
}
```

**Next.js Implementation**:
```typescript
// middleware.ts (line 117)
const logEndpoint = process.env.NEXT_PUBLIC_LOG_ENDPOINT;

if (!logEndpoint) {
  return; // Skip external logging
}

try {
  const response = await fetch(logEndpoint, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(auditLog),
  });
}
```

**Note**: Next.js requires `NEXT_PUBLIC_` prefix for environment variables used in Edge Runtime middleware.

---

### 3. Environment Name

**C# Variable**:
```bash
ASPNETCORE_ENVIRONMENT=Development  # or Production, Staging
```

**Next.js Equivalent**:
```bash
NODE_ENV=development  # or production, test
```

**Status**: ✅ **Correctly mapped**

**Usage Comparison**:

| C# | Next.js | Purpose |
|---|---|---|
| `ASPNETCORE_ENVIRONMENT=Development` | `NODE_ENV=development` | Local development |
| `ASPNETCORE_ENVIRONMENT=Production` | `NODE_ENV=production` | Production deployment |
| `ASPNETCORE_ENVIRONMENT=Staging` | `NODE_ENV=production` + custom var | Staging environment |

**Redis Cache Key Construction**:
```csharp
// C#
var env = Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT");
var cacheKey = $"CacheLoader:{env}:ScanItemActions:{org}";
// Result: CacheLoader:Production:ScanItemActions:napbiotec

// Next.js (when Redis implemented)
const env = process.env.NODE_ENV;
const cacheKey = `CacheLoader:${env}:ScanItemActions:${org}`;
// Result: CacheLoader:production:ScanItemActions:napbiotec
```

⚠️ **Potential Issue**: C# uses `Production` (capitalized), Next.js uses `production` (lowercase)

**Solution**: Need to handle case sensitivity when implementing Redis:
```typescript
// Normalize environment name to match C# convention
const env = process.env.NODE_ENV === 'production' ? 'Production' : 
            process.env.NODE_ENV === 'development' ? 'Development' : 
            'Development';
```

---

## Recommended `.env` Updates

### Development `.env` (nextjs/.env)

```properties
# =============================================================================
# ONIX V2 WEB SCAN - ENVIRONMENT VARIABLES
# =============================================================================

# -----------------------------------------------------------------------------
# Redis Configuration (Production - required for fetching encryption keys)
# -----------------------------------------------------------------------------
# Uncomment and configure for production deployment
# In production, encryption keys are stored in Redis with pattern:
# CacheLoader:{Environment}:ScanItemActions:{organization}
# 
# REDIS_HOST=localhost
# REDIS_PORT=6379
# REDIS_PASSWORD=                    # Optional: Redis password
# REDIS_TLS=false                    # Optional: Use TLS for Redis connection

# -----------------------------------------------------------------------------
# Encryption Configuration (Development Fallback)
# -----------------------------------------------------------------------------
# These are fallback keys used when Redis is not available (local development)
# In production, keys will be fetched from Redis cache
# 
# IMPORTANT: 
# - Key MUST be 16, 24, or 32 characters (AES-128/192/256)
# - IV MUST be exactly 16 characters
# - DO NOT commit production keys to version control
# - Get production keys from Redis: CacheLoader:Production:ScanItemActions:{org}
ENCRYPTION_KEY=wCCLYnTAlfFk2ccB      # 16 chars = AES-128 (development only)
ENCRYPTION_IV=2908yrhozH0ppXmA       # 16 chars (development only)

# -----------------------------------------------------------------------------
# External Logging Configuration (Optional)
# -----------------------------------------------------------------------------
# Endpoint for sending audit logs to external logging service
# If not set, logs will only be written to console
# 
# NEXT_PUBLIC_LOG_ENDPOINT=https://your-logging-service.com/api/logs

# -----------------------------------------------------------------------------
# Environment Configuration
# -----------------------------------------------------------------------------
# NODE_ENV is used for:
# - Next.js build optimization
# - Redis cache key construction (CacheLoader:{NODE_ENV}:ScanItemActions:{org})
# - Logging verbosity
NODE_ENV=development

# -----------------------------------------------------------------------------
# Server Configuration
# -----------------------------------------------------------------------------
# Port for Next.js development server
# Note: Port 5000 is used by macOS Control Center (AirPlay)
PORT=5001

# -----------------------------------------------------------------------------
# Next.js Configuration
# -----------------------------------------------------------------------------
# NEXT_PUBLIC_ prefix makes variables accessible in browser/edge runtime
# Use for non-sensitive configuration only
# 
# NEXT_PUBLIC_API_BASE_URL=http://localhost:5001
# NEXT_PUBLIC_ENABLE_ANALYTICS=false
```

---

### Production `.env.production` (Example)

```properties
# =============================================================================
# PRODUCTION ENVIRONMENT VARIABLES
# =============================================================================

# Redis Configuration (REQUIRED for production)
REDIS_HOST=your-production-redis.example.com
REDIS_PORT=6379
REDIS_PASSWORD=your-secure-redis-password
REDIS_TLS=true

# Encryption Configuration (Fetched from Redis, these are fallback only)
# Get actual production keys from Redis:
# redis-cli GET "CacheLoader:Production:ScanItemActions:napbiotec"
ENCRYPTION_KEY=                      # Leave empty - will fetch from Redis
ENCRYPTION_IV=                       # Leave empty - will fetch from Redis

# External Logging Configuration
NEXT_PUBLIC_LOG_ENDPOINT=https://logs.your-company.com/api/audit

# Environment Configuration
NODE_ENV=production

# Server Configuration
PORT=5000
HOSTNAME=0.0.0.0                     # Listen on all interfaces (Docker)
```

---

## Implementation Checklist

### For Development (Current State)
- [x] ENCRYPTION_KEY configured (16 bytes, AES-128)
- [x] ENCRYPTION_IV configured (16 bytes)
- [x] NODE_ENV=development
- [x] PORT=5001 (avoiding macOS AirPlay port)
- [ ] REDIS_HOST/REDIS_PORT (optional, commented out)
- [ ] NEXT_PUBLIC_LOG_ENDPOINT (optional, not configured)

### For Production Deployment
- [ ] **Configure Redis** (CRITICAL)
  - [ ] Set REDIS_HOST
  - [ ] Set REDIS_PORT
  - [ ] Set REDIS_PASSWORD (if required)
  - [ ] Set REDIS_TLS=true (recommended)
  - [ ] Test Redis connection

- [ ] **Implement Redis Integration** (CODE CHANGES NEEDED)
  - [ ] Install `ioredis` package: `npm install ioredis`
  - [ ] Create `lib/redis.ts` client
  - [ ] Update `app/verify/page.tsx` to fetch keys from Redis
  - [ ] Handle Redis connection errors gracefully
  - [ ] Implement fallback to env vars if Redis unavailable

- [ ] **Configure External Logging** (OPTIONAL)
  - [ ] Set NEXT_PUBLIC_LOG_ENDPOINT
  - [ ] Test log delivery to external endpoint
  - [ ] Configure log retention and monitoring

- [ ] **Get Production Encryption Keys**
  - [ ] Connect to production Redis
  - [ ] Fetch keys: `GET CacheLoader:Production:ScanItemActions:{org}`
  - [ ] Validate key lengths (16/24/32 bytes for key, 16 bytes for IV)
  - [ ] Store in production secrets manager

- [ ] **Environment Configuration**
  - [ ] Set NODE_ENV=production
  - [ ] Set PORT=5000 (or your production port)
  - [ ] Set HOSTNAME=0.0.0.0 (for Docker/K8s)

---

## Redis Implementation Plan

### 1. Install Redis Client

```bash
cd nextjs
npm install ioredis
npm install --save-dev @types/ioredis
```

### 2. Create Redis Client (`lib/redis.ts`)

```typescript
import Redis from 'ioredis';

let redisClient: Redis | null = null;

export function getRedisClient(): Redis | null {
  // Only create Redis client if configuration exists
  const redisHost = process.env.REDIS_HOST;
  const redisPort = process.env.REDIS_PORT;

  if (!redisHost || !redisPort) {
    console.log('Redis not configured, using environment variable fallback');
    return null;
  }

  // Create client if not exists
  if (!redisClient) {
    const redisConfig = {
      host: redisHost,
      port: parseInt(redisPort, 10),
      password: process.env.REDIS_PASSWORD,
      tls: process.env.REDIS_TLS === 'true' ? {} : undefined,
      retryStrategy: (times: number) => {
        const delay = Math.min(times * 50, 2000);
        return delay;
      },
    };

    try {
      redisClient = new Redis(redisConfig);
      console.log('Redis client created successfully');
    } catch (error) {
      console.error('Failed to create Redis client:', error);
      return null;
    }
  }

  return redisClient;
}

export interface EncryptionConfig {
  Encryption_Key: string;
  Encryption_Iv: string;
}

export async function getEncryptionConfig(org: string): Promise<EncryptionConfig | null> {
  const redis = getRedisClient();

  if (!redis) {
    // Fallback to environment variables (development)
    return {
      Encryption_Key: process.env.ENCRYPTION_KEY || '',
      Encryption_Iv: process.env.ENCRYPTION_IV || '',
    };
  }

  try {
    // Normalize environment name to match C# convention (capitalized)
    const env = process.env.NODE_ENV === 'production' ? 'Production' : 'Development';
    const cacheKey = `CacheLoader:${env}:ScanItemActions:${org}`;

    console.log(`Fetching encryption config from Redis: ${cacheKey}`);

    const configJson = await redis.get(cacheKey);

    if (!configJson) {
      console.warn(`Encryption config not found in Redis for key: ${cacheKey}`);
      // Fallback to environment variables
      return {
        Encryption_Key: process.env.ENCRYPTION_KEY || '',
        Encryption_Iv: process.env.ENCRYPTION_IV || '',
      };
    }

    const config: EncryptionConfig = JSON.parse(configJson);
    console.log('Successfully fetched encryption config from Redis');
    return config;

  } catch (error) {
    console.error('Error fetching encryption config from Redis:', error);
    // Fallback to environment variables
    return {
      Encryption_Key: process.env.ENCRYPTION_KEY || '',
      Encryption_Iv: process.env.ENCRYPTION_IV || '',
    };
  }
}
```

### 3. Update Verify Page (`app/verify/page.tsx`)

**Current Implementation** (lines 360-361):
```typescript
// Get encryption config from environment (matching C# GetEncryptionConfig)
const key = process.env.ENCRYPTION_KEY;
const iv = process.env.ENCRYPTION_IV;
```

**Updated Implementation**:
```typescript
// Get encryption config from Redis or environment fallback
import { getEncryptionConfig } from '@/lib/redis';

// ... inside the page component
const org = searchParams.org || 'unknown';
const encryptionConfig = await getEncryptionConfig(org);

const key = encryptionConfig?.Encryption_Key;
const iv = encryptionConfig?.Encryption_Iv;
```

### 4. Test Redis Integration

```bash
# 1. Start local Redis (for testing)
docker run -d --name redis-test -p 6379:6379 redis:latest

# 2. Add test data to Redis
redis-cli SET "CacheLoader:Development:ScanItemActions:napbiotec" '{"Encryption_Key":"wCCLYnTAlfFk2ccB","Encryption_Iv":"2908yrhozH0ppXmA"}'

# 3. Update .env
echo "REDIS_HOST=localhost" >> nextjs/.env
echo "REDIS_PORT=6379" >> nextjs/.env

# 4. Start Next.js dev server
cd nextjs
npm run dev

# 5. Test verification endpoint
curl "http://localhost:5001/verify?org=napbiotec&theme=default&data=..."
```

---

## Summary

### Currently Missing from Next.js:

1. **Redis Configuration** (CRITICAL for production):
   - ✅ Variables defined in `.env` (commented out)
   - ❌ Redis client not implemented
   - ❌ Cannot fetch organization-specific encryption keys

2. **Log Endpoint Configuration** (OPTIONAL):
   - ❌ Not defined in `.env`
   - ⚠️ Logs only to console (no external logging)

3. **Environment Name Mapping** (MINOR):
   - ✅ NODE_ENV correctly set
   - ⚠️ Need case normalization for Redis cache keys (Production vs production)

### Priority Actions:

1. **HIGH**: Implement Redis integration for production encryption key fetching
2. **MEDIUM**: Add NEXT_PUBLIC_LOG_ENDPOINT for external logging
3. **LOW**: Add environment name normalization for Redis cache keys

### Development Status:

- ✅ **Current**: Works fine for development (uses .env fallback keys)
- ⚠️ **Production**: Needs Redis implementation to match C# behavior

---

**Created By**: GitHub Copilot AI Assistant  
**Date**: 2024-10-18  
**Status**: ⚠️ **Redis Implementation Required for Production**
