# Customer Registration Check - Test Guide

## CSV File Data

**File:** `napbiotec_dev_20250903_202509031324-Z8P.csv`  
**Total Records:** 100 products (E0000001 to E0000100)

## CSV Structure

```csv
SERIAL,PIN,QR (URL)
E0000001,20WVU7D,https://scan-dev.please-scan.com/org/napbiotec/Verify/E0000001/20WVU7D
E0000076,K5XA05L,https://scan-dev.please-scan.com/org/napbiotec/Verify/E0000076/K5XA05L
...
```

## Known Test Cases

### âœ… Already Registered Product
**Line 76:**
```
SERIAL: E0000076
PIN: K5XA05L
URL: https://scan-dev.please-scan.com/org/napbiotec/Verify/E0000076/K5XA05L
```

**Status:** Already registered (from your test data)  
**Expected behavior:**
- Click "Register" button
- Backend GetCustomer returns: `"status": "SUCCESS"` with email
- Modal shows: "Already registered with [email]"

### ðŸ†• Unregistered Products (Pick any for testing new registration)

**Recommended Test Lines:**

**Line 2:**
```
SERIAL: E0000001
PIN: 20WVU7D
URL: https://scan-dev.please-scan.com/org/napbiotec/Verify/E0000001/20WVU7D
```

**Line 50:**
```
SERIAL: E0000050
PIN: OPH7EHK
URL: https://scan-dev.please-scan.com/org/napbiotec/Verify/E0000050/OPH7EHK
```

**Line 100:**
```
SERIAL: E0000100
PIN: VEZA2UZ
URL: https://scan-dev.please-scan.com/org/napbiotec/Verify/E0000100/VEZA2UZ
```

**Expected behavior:**
- Click "Register" button
- Backend GetCustomer returns: `"status": "CUSTOMER_NOTFOUND"`
- Modal shows registration form (enter email, request OTP, submit)

## How GetCustomer Check Works

When you click "Register" on any product:

### 1. Frontend calls getCustomerUrl from backend response
```javascript
const getCustomerUrl = verifyData.getCustomerUrl;
// Example: /api/proxy?url=aHR0cHM6Ly9zY2FuLWRldi5wbGVhc2Utc2Nhbi5jb20v...
```

### 2. Proxy forwards to backend
```
GET https://scan-dev.please-scan.com/org/napbiotec/GetCustomer/{serial}/{pin}/{otp}
```

### 3. Backend checks if customer exists for this product
- Queries database for registration record
- Returns customer email if registered
- Returns CUSTOMER_NOTFOUND if not registered

### 4. Frontend handles response
```javascript
if (status === "SUCCESS") {
  // Product already registered
  showModal("Already registered with " + email);
} else if (status === "CUSTOMER_NOTFOUND") {
  // Product not registered yet
  showRegistrationForm();
}
```

## Testing Instructions

### Test 1: Already Registered (E0000076)

```bash
# Option A: Use test page
open http://localhost:5001/test?scenario=already-registered

# Option B: Use real verify URL
open "https://scan-dev.please-scan.com/org/napbiotec/Verify/E0000076/K5XA05L"
```

**Expected flow:**
1. Page loads with "ALREADY_REGISTERED" status
2. Click "Register" button
3. GET /api/proxy â†’ GetCustomer/E0000076/K5XA05L
4. Response: `{"status": "SUCCESS", "email": "existing@napbiotec.com"}`
5. Modal: "Already registered with existing@napbiotec.com"

### Test 2: New Registration (E0000001 or any unregistered)

```bash
# Use real verify URL (pick any unregistered serial)
open "https://scan-dev.please-scan.com/org/napbiotec/Verify/E0000001/20WVU7D"
```

**Expected flow:**
1. Page loads with "VALID" or "SUCCESS" status
2. Click "Register" button
3. GET /api/proxy â†’ GetCustomer/E0000001/20WVU7D
4. Response: `{"status": "CUSTOMER_NOTFOUND"}`
5. Modal: Registration form appears
6. Enter email: test@example.com
7. Click "Request OTP"
8. GET /api/proxy â†’ GetOtpViaEmail/.../test@example.com
9. Check email for 6-digit OTP
10. Enter OTP and submit
11. POST /api/proxy â†’ RegisterCustomer
12. Success! Product now registered to your email

## Quick Test Matrix

| Serial | PIN | Status | Use Case |
|--------|-----|--------|----------|
| E0000076 | K5XA05L | âœ… Registered | Test "already registered" flow |
| E0000001 | 20WVU7D | ðŸ†• Unregistered | Test new registration |
| E0000050 | OPH7EHK | ðŸ†• Unregistered | Test new registration |
| E0000100 | VEZA2UZ | ðŸ†• Unregistered | Test new registration |

## Verification Script

Check any serial/pin registration status:

```bash
# Replace with your serial/pin
SERIAL="E0000001"
PIN="20WVU7D"
ORG="napbiotec"

# Note: You'll need a valid OTP token - this is usually generated by backend
# For testing, you can get it from the verify page response

echo "Checking registration status for $SERIAL..."
curl -s "https://scan-dev.please-scan.com/org/$ORG/GetCustomer/$SERIAL/$PIN/test-otp" \
  | jq '{status, email}'
```

## Summary

âœ… **CSV contains 100 test products**  
âœ… **E0000076** is confirmed registered (use for "already registered" test)  
âœ… **E0000001-E0000075, E0000077-E0000100** likely unregistered (use for new registration test)  
âœ… **GetCustomer API checks registration status for each serial/pin**  
âœ… **Frontend uses getCustomerUrl from backend response**  

**Everything is working as designed!** ðŸŽ‰
