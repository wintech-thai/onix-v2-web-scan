@model OnixWebScan.Models.VerifyViewModel
@using System.Text;
@using System.Net;
@using System.Collections.Generic;
@{
    ViewData["Title"] = "Verify";
    ViewData["MainClass"] = "ox-main ox-main--center";

    var p = Model?.Payload;
    var s = p?.ScanItem;

    string Norm(string? v) => string.IsNullOrWhiteSpace(v) ? "UNKNOWN" : v.Trim().ToUpperInvariant();
    var rawStatus = Norm(p?.Status);
    bool IsSuccess(string st) => st is "OK" or "SUCCESS" or "VALID";
    bool IsError(string st) => st is "ALREADY_REGISTERED" or "NOTFOUND" or
                               "PARAM_MISSING" or "PARAMETER_MISSING" or "NO_DATA" or
                               "DECRYPT_FAIL" or "DECRYPT_ERROR" or "INVALID" or "FAILED";
    bool isSuccess = IsSuccess(rawStatus);
    bool isError   = IsError(rawStatus);

    string statusCode = isSuccess ? "SUCCESS" : rawStatus;
    var titleText = isSuccess ? "ยืนยันแล้วว่าเป็นสินค้าแท้"
        : isError ? (rawStatus switch {
            "ALREADY_REGISTERED" => "โค้ดนี้ถูกใช้ไปแล้ว",
            "NOTFOUND" => "ไม่พบโค้ดนี้ในระบบ",
            "PARAM_MISSING" or "PARAMETER_MISSING" or "NO_DATA" => "ข้อมูลที่ส่งมาไม่ครบ",
            "DECRYPT_FAIL" or "DECRYPT_ERROR" => "ไม่สามารถถอดรหัสข้อมูลได้",
            _ => "ตรวจสอบไม่ผ่าน"
        }) : "สถานะไม่แน่ชัด กรุณาติดต่อทีมงาน";

    var messages = new List<string>();
    if (isSuccess) {
        messages.Add("ขอบคุณที่ตรวจสอบ — คุณกำลังใช้สินค้าของแท้");
        if (!string.IsNullOrWhiteSpace(p?.DescriptionEng)) messages.Add(p!.DescriptionEng);
    } else if (isError) {
        switch (rawStatus) {
            case "ALREADY_REGISTERED":
                messages.Add("โค้ดนี้ถูกใช้งานไปก่อนหน้า อาจถูกลงทะเบียนโดยผู้อื่นหรือร้านค้า");
                messages.Add("หากเพิ่งซื้อ กรุณาติดต่อทีมงานเพื่อช่วยตรวจสอบเพิ่มเติม");
                break;
            case "NOTFOUND":
                messages.Add("ไม่พบข้อมูลโค้ดในระบบ อาจพิมพ์ผิดหรือโค้ดไม่ถูกต้อง");
                break;
            case "PARAM_MISSING":
            case "PARAMETER_MISSING":
            case "NO_DATA":
                messages.Add("ระบบไม่ได้รับพารามิเตอร์ที่จำเป็นครบถ้วน");
                break;
            case "DECRYPT_FAIL":
            case "DECRYPT_ERROR":
                messages.Add("ได้รับข้อมูลมาแล้วแต่ไม่สามารถถอดรหัสได้");
                break;
            default:
                messages.Add("เกิดข้อผิดพลาดในการตรวจสอบ");
                break;
        }
        if (!string.IsNullOrWhiteSpace(p?.DescriptionEng)) messages.Add(p!.DescriptionEng);
    } else {
        messages.Add("ไม่สามารถสรุปผลได้จากข้อมูลที่ได้รับ");
        if (!string.IsNullOrWhiteSpace(p?.DescriptionEng)) messages.Add(p!.DescriptionEng);
    }

    string? encodedProductUrl = null;
    if (!string.IsNullOrWhiteSpace(s?.Url)) {
        var b64 = Convert.ToBase64String(Encoding.UTF8.GetBytes(s!.Url));
        encodedProductUrl = WebUtility.UrlEncode(b64);
    }
    var primaryHref = isSuccess
        ? (encodedProductUrl is null ? "#" : Url.Action("OpenExternal","Verify", new { u = encodedProductUrl }))
        : Url.Action("ContactSupport","Verify", new { serial = s?.Serial, pin = s?.Pin, brand = s?.OrgId });
    var primaryText = isSuccess ? "เปิดข้อมูลสินค้า" : "ติดต่อทีมดูแล";

    var iconId =
        isSuccess ? "i-check-circle"
        : rawStatus == "ALREADY_REGISTERED" ? "i-warning"
        : isError ? "i-x-circle"
        : "i-warning";

    var heroBg =
        isSuccess ? "bg-success"
        : rawStatus == "ALREADY_REGISTERED" ? "bg-warn"
        : isError ? "bg-error"
        : "bg-warn";
}

<svg aria-hidden="true" style="position:absolute;width:0;height:0;overflow:hidden">
  <symbol id="i-check-circle" viewBox="0 0 24 24">
    <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/>
    <path d="M8 12l3 3 5-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </symbol>
  <symbol id="i-x-circle" viewBox="0 0 24 24">
    <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/>
    <path d="M9 9l6 6M15 9l-6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  </symbol>
  <symbol id="i-warning" viewBox="0 0 24 24">
    <path d="M12 3l10 18H2L12 3z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
    <path d="M12 9v5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <circle cx="12" cy="17" r="1.2" fill="currentColor"/>
  </symbol>
  <symbol id="i-link" viewBox="0 0 24 24">
    <path d="M10 14l-2 2a4 4 0 1 1-6-6l2-2M14 10l2-2a4 4 0 1 1 6 6l-2 2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <path d="M8 12h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  </symbol>
</svg>

<style>
  .hero{ margin-inline:auto; }
  .hero{
    border-radius:22px; padding:28px 24px; color:#fff; position:relative; overflow:hidden;
    box-shadow:0 16px 40px rgba(0,0,0,.18);
    width:min(720px, 100%);
    background:#111827;
  }
  .hero:before{
    content:""; position:absolute; inset:-1px; border-radius:24px; pointer-events:none;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.20);
  }

  .bg-success{ background:#16a34a !important; }
  .bg-error{   background:#dc2626 !important; }
  .bg-warn{    background:#d97706 !important; }

  .statusWrap{ display:flex; align-items:center; gap:18px; flex-wrap:wrap }
  .statusIcon{ width:60px; height:60px; opacity:.95; filter:drop-shadow(0 6px 18px rgba(0,0,0,.25)) }
  .statusCode{ font-weight:900; letter-spacing:1px; line-height:1; font-size:44px; text-transform:uppercase }
  .statusTitle{ font-size:18px; opacity:.95; margin-top:6px }
  .lead{ margin-top:14px }
  .lead .line{ opacity:.98; margin:6px 0 }
  .cta{ display:flex; gap:10px; flex-wrap:wrap; margin-top:18px }
  .btn{
    display:inline-flex; align-items:center; gap:8px; text-decoration:none; border-radius:14px; padding:12px 16px;
    border:1px solid rgba(255,255,255,.45); background:rgba(255,255,255,.12); color:#fff; backdrop-filter:blur(6px);
    box-shadow:0 6px 20px rgba(0,0,0,.25);
  }
  .btn svg{ width:18px; height:18px }
  .btn:hover{ background:rgba(255,255,255,.18) }
</style>

<div class="container ox-container">
  <div class="hero @heroBg">
    <div class="statusWrap">
      <svg class="statusIcon"><use href="#@iconId" /></svg>
      <div>
        <div class="statusCode">@statusCode</div>
        <div class="statusTitle">@titleText</div>
      </div>
    </div>

    <div class="lead">
      @foreach (var line in messages) { <div class="line">@line</div> }
    </div>

    <div class="cta">
      <a class="btn" href="@primaryHref"><svg><use href="#i-link"/></svg> @primaryText</a>
    </div>
  </div>
</div>
